name : Deploy to AWS S3,Cloudfront and GitHub Pages
on :
  push :
    branches :
      - main
jobs :
  build :
    runs-on : ubuntu-latest

    steps :
      - name : Checkout code from GitHub
        uses : actions/checkout@v4
            
      - name : Setup Node.js
        uses : actions/setup-node@v4
        with :
          node-version : '22'
          cache : 'npm'
            
      - name : Install dependencies
        run : npm ci
        
      - name : Build application
        run : npm run build

      - name : Upload Artifact
        uses : actions/upload-artifact@v4
        with : 
          name : build-output
          path : dist/
            
  deploy-aws :
    runs-on : ubuntu-latest
    needs : build
    
    steps :
      - name : Download Artifact
        uses : actions/download-artifact@v4
        with : 
          name : build-output
          path : dist/
      
      - name : Configure AWS credentials
        uses : aws-actions/configure-aws-credentials@v4
        with :
          aws-access-key-id : ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key : ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region : ap-south-1

      - name : Deploy to S3
        run : |
          aws s3 sync dist/ s3://${{ secrets.AWS_S3_BUCKET }} --delete

      - name : Invalidate CloudFront cache
        run : |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.AWS_CLOUDFRONT_ID }} \
            --paths "/*"

      - name : Deployment Complete
        run : echo "Deployed to AWS Successfully!"

  deploy-gh-pages :
    runs-on : ubuntu-latest
    needs : build
    
    steps :
      - name : Download Artifact
        uses : actions/download-artifact@v4
        with : 
          name : build-output
          path : dist/
          
      - name : Commit and Push changes
        run : |
          cd dist
          git init
          git config --global user.name "github-actions[bot]" 
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Deploy build"
          git push https://${{ secrets.GH_PAGES_TOKEN }}@github.com/SamrithaShree.github.io.git main --force

      - name : Deployment Complete
        run : echo "Deployed to GitHub Pages Successfully!"

